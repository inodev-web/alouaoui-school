# üöÄ Guide d'Utilisation - Tests E2E et CI/CD

Ce guide explique comment utiliser l'infrastructure compl√®te de tests E2E avec Cypress et GitHub Actions pour le projet **Alouaoui School**.

## üìã Table des Mati√®res

1. [üîß Configuration Initiale](#-configuration-initiale)
2. [üß™ Ex√©cution des Tests Locaux](#-ex√©cution-des-tests-locaux)
3. [‚òÅÔ∏è GitHub Actions CI/CD](#Ô∏è-github-actions-cicd)
4. [üìä Rapports et Artefacts](#-rapports-et-artefacts)
5. [üîç Debugging et D√©pannage](#-debugging-et-d√©pannage)
6. [‚ö° Optimisations et Bonnes Pratiques](#-optimisations-et-bonnes-pratiques)

---

## üîß Configuration Initiale

### Pr√©requis Syst√®me

**Backend (Laravel 11):**
```bash
- PHP 8.2+
- Composer 2.0+
- MySQL/SQLite
- Extensions PHP: mbstring, dom, fileinfo, mysql
```

**Frontend (React):**
```bash
- Node.js 18+
- npm 9+
```

**Outils de Test:**
```bash
- Cypress 13+
- Chrome/Firefox browsers
```

### Installation Rapide

```bash
# 1. Clone du projet
git clone https://github.com/inodev-web/alouaoui-school.git
cd alouaoui-school

# 2. Backend Laravel
cd backend
composer install
cp .env.example .env
php artisan key:generate
php artisan migrate --seed

# 3. Frontend React
cd ../frontend
npm install
npx cypress install

# 4. V√©rification installation
npm run dev        # Terminal 1 (Frontend)
cd ../backend && php artisan serve  # Terminal 2 (Backend)
```

---

## üß™ Ex√©cution des Tests Locaux

### Option 1: Script Automatis√© (Recommand√©)

**Linux/macOS:**
```bash
# Tous les tests
./scripts/run-e2e-tests.sh

# Tests sp√©cifiques
./scripts/run-e2e-tests.sh auth chrome
./scripts/run-e2e-tests.sh critical firefox
./scripts/run-e2e-tests.sh dashboard

# Aide
./scripts/run-e2e-tests.sh --help
```

**Windows:**
```batch
REM Tous les tests
scripts\run-e2e-tests.bat

REM Tests sp√©cifiques
scripts\run-e2e-tests.bat auth chrome
scripts\run-e2e-tests.bat critical firefox

REM Aide
scripts\run-e2e-tests.bat --help
```

### Option 2: Ex√©cution Manuelle

```bash
# 1. D√©marrer le backend
cd backend
php artisan serve --port=8000 &

# 2. D√©marrer le frontend
cd frontend
npm run dev &

# 3. Ex√©cuter les tests Cypress
npm run cypress:open    # Mode interactif
npm run cypress:run     # Mode headless

# 4. Tests sp√©cifiques
npx cypress run --spec "cypress/e2e/login.cy.js"
npx cypress run --spec "cypress/e2e/events.cy.js" --browser firefox
```

### Suites de Tests Disponibles

| Suite | Description | Fichiers inclus |
|-------|-------------|-----------------|
| `all` | Tous les tests | `*.cy.js` |
| `auth` | Authentification | `login.cy.js`, `forgot-password.cy.js` |
| `dashboard` | Tableaux de bord | `student-dashboard.cy.js` |
| `events` | Gestion √©v√©nements | `events.cy.js` |
| `profile` | Gestion profil | `profile.cy.js` |
| `chapters` | Apprentissage | `chapters.cy.js` |
| `critical` | Tests critiques | `login.cy.js`, `events.cy.js` |

---

## ‚òÅÔ∏è GitHub Actions CI/CD

### üîÑ Workflows Disponibles

#### 1. **Pipeline Principal** (`.github/workflows/e2e-tests.yml`)

**D√©clencheurs:**
- Push sur `main`, `develop`
- Pull Request vers `main`
- Ex√©cution manuelle avec param√®tres

**Jobs:**
1. **Setup & Validation** - Configuration et d√©tection des changements
2. **Backend Tests** - Tests unitaires Laravel + d√©marrage serveur
3. **E2E Tests Matrix** - Tests Cypress en parall√®le (multiple browsers)
4. **Report Results** - Fusion des rapports et g√©n√©ration des artefacts
5. **Deploy** - D√©ploiement automatique si tous les tests passent

**Utilisation:**

```bash
# D√©clenchement automatique
git push origin main

# Ex√©cution manuelle depuis GitHub
# Actions > E2E Tests > Run workflow
# - Choisir la suite de tests
# - Choisir le navigateur
# - Cliquer "Run workflow"
```

#### 2. **Tests Rapides** (`.github/workflows/quick-e2e.yml`)

**D√©clencheurs:**
- Push sur branches `develop`, `feature/*`
- Pull Requests

**Caract√©ristiques:**
- Tests critiques seulement (`login`, `events`)
- Ex√©cution rapide (< 5 minutes)
- Feedback imm√©diat pour les d√©veloppeurs

### üìä Configuration des Secrets GitHub

Ajoutez ces secrets dans votre repository GitHub:

```
Settings > Secrets and variables > Actions > New repository secret
```

| Secret | Description | Requis |
|--------|-------------|---------|
| `CYPRESS_RECORD_KEY` | Cl√© pour Cypress Dashboard | Optionnel |
| `DATABASE_URL` | URL de la base de donn√©es de test | Optionnel |

### üéØ Matrice de Tests

Le pipeline ex√©cute automatiquement les tests sur:
- **Navigateurs:** Chrome, Firefox
- **Environnements:** Ubuntu Latest
- **Versions Node.js:** 20
- **Versions PHP:** 8.2

---

## üìä Rapports et Artefacts

### Types de Rapports G√©n√©r√©s

#### 1. **Rapports HTML Interactifs**
```
frontend/cypress/reports/merged-report.html
```
- Vue d'ensemble des r√©sultats
- D√©tails par test
- Dur√©es d'ex√©cution
- Screenshots des √©checs

#### 2. **Rapports JSON**
```json
{
  "stats": {
    "tests": 42,
    "passes": 40,
    "failures": 2,
    "duration": 120000
  },
  "results": [...],
  "failures": [...]
}
```

#### 3. **Artefacts Visuels**
- **Vid√©os:** Enregistrement complet de chaque test
- **Screenshots:** Captures d'√©cran des √©checs
- **Logs:** Logs d√©taill√©s frontend/backend

### Acc√®s aux Rapports

**Local:**
```bash
# Ouvrir le rapport dans le navigateur
open frontend/cypress/reports/merged-report.html  # macOS
xdg-open frontend/cypress/reports/merged-report.html  # Linux
start frontend\cypress\reports\merged-report.html  # Windows
```

**GitHub Actions:**
1. Aller dans l'onglet **Actions**
2. Cliquer sur le workflow termin√©
3. T√©l√©charger les artefacts:
   - `üìä-final-test-reports`
   - `cypress-videos-*`
   - `cypress-screenshots-*`

### Exemple de Rapport de Summary

```markdown
## üß™ E2E Tests - Comprehensive Results Report

**Workflow:** E2E Tests - Cypress CI/CD Pipeline
**Run ID:** 1234567890
**Branch:** main
**Commit:** abc123def456
**Date:** 2025-01-25 14:30:00 UTC

## üìä Test Statistics

| Metric | Value |
|--------|-------|
| **Total Tests** | 89 |
| **Passed** | ‚úÖ 87 |
| **Failed** | ‚ùå 2 |
| **Skipped** | ‚è≠Ô∏è 0 |
| **Duration** | 245000ms |
| **Success Rate** | 98% |
```

---

## üîç Debugging et D√©pannage

### Probl√®mes Courants

#### 1. **Tests qui √âchouent Localement**

```bash
# V√©rifier les services
curl http://localhost:5173        # Frontend
curl http://127.0.0.1:8000/api/health  # Backend

# Logs d√©taill√©s
npm run cypress:open  # Mode debug visuel

# V√©rifier la base de donn√©es
cd backend
php artisan migrate:fresh --seed --env=testing
```

#### 2. **Timeouts dans les Tests**

```javascript
// Augmenter les timeouts dans cypress.config.js
{
  defaultCommandTimeout: 15000,    // Par d√©faut: 10s
  requestTimeout: 15000,          // Par d√©faut: 10s
  responseTimeout: 45000          // Par d√©faut: 30s
}
```

#### 3. **Probl√®mes de Mock API**

```javascript
// V√©rifier les interceptors dans les tests
cy.intercept('GET', '**/api/events', { fixture: 'events.json' }).as('getEvents');
cy.wait('@getEvents');  // Attendre explicitement
```

#### 4. **Erreurs en CI/CD GitHub Actions**

```yaml
# Ajouter plus de logs dans le workflow
- name: Debug services
  run: |
    echo "Backend status:" && curl -s http://localhost:8000/api/health || echo "Backend not responding"
    echo "Frontend status:" && curl -s -I http://localhost:5173 || echo "Frontend not responding"
    netstat -tlnp | grep -E ':(8000|5173)'
```

### Logs et Debugging

#### Logs Backend Laravel
```bash
# En local
tail -f backend/storage/logs/laravel.log

# En CI (via artefacts)
# T√©l√©charger: backend-logs artifact
```

#### Logs Frontend React
```bash
# Console du navigateur dans Cypress
cy.window().then((win) => {
  console.log(win.console);
});

# Logs personnalis√©s
cy.task('log', 'Message de debug');
```

#### Cypress Debug Commands
```javascript
// Dans les tests
cy.debug();          // Pause pour inspection
cy.screenshot();     // Capture manuelle
cy.wait(2000);       // Pause temporelle
```

---

## ‚ö° Optimisations et Bonnes Pratiques

### Performance des Tests

#### 1. **Parall√©lisation**
```bash
# Ex√©cution parall√®le locale
npm run cypress:run -- --parallel --record --key YOUR_RECORD_KEY

# En CI - utilise la matrice automatiquement
```

#### 2. **Cache et Optimisations**
```yaml
# Dans GitHub Actions
- uses: actions/cache@v3
  with:
    path: |
      frontend/node_modules
      ~/.cache/Cypress
    key: npm-cypress-${{ hashFiles('frontend/package-lock.json') }}
```

#### 3. **Tests S√©lectifs**
```bash
# Tester seulement les changements
git diff --name-only main...HEAD | grep -E '\.(js|jsx)$'

# Tests par tag
npx cypress run --env grepTags=@smoke
```

### Maintenance des Tests

#### 1. **Donn√©es de Test Stables**
```javascript
// Utiliser des fixtures plut√¥t que des donn√©es dynamiques
cy.fixture('student-profile.json').then((profile) => {
  // Test avec donn√©es contr√¥l√©es
});
```

#### 2. **S√©lecteurs Robustes**
```javascript
// ‚úÖ Bon - data-testid
cy.get('[data-testid="login-button"]');

// ‚ùå √Ä √©viter - classes CSS
cy.get('.btn-primary');
```

#### 3. **Attentes Explicites**
```javascript
// ‚úÖ Attendre explicitement
cy.get('[data-testid="loading"]').should('not.exist');
cy.get('[data-testid="content"]').should('be.visible');

// ‚ùå Attentes implicites
cy.wait(3000);
```

### Monitoring et M√©triques

#### 1. **Dashboard Cypress**
```bash
# Enregistrer les tests sur Cypress Dashboard
npx cypress run --record --key YOUR_KEY
```

#### 2. **M√©triques CI/CD**
- Temps d'ex√©cution par test
- Taux de r√©ussite par suite
- Tendances sur le temps

#### 3. **Alertes Automatiques**
```yaml
# Dans GitHub Actions - notification Slack/Teams
- name: Notify on failure
  if: failure()
  uses: 8398a7/action-slack@v3
  with:
    status: failure
    text: 'E2E Tests failed on ${{ github.ref }}'
```

---

## üéØ Exemples d'Usage Avanc√©s

### Test de R√©gression Automatique

```javascript
// cypress/e2e/regression.cy.js
describe('Regression Tests', () => {
  const criticalPaths = [
    '/login',
    '/student/dashboard', 
    '/student/chapters',
    '/admin/events'
  ];

  criticalPaths.forEach((path) => {
    it(`should load ${path} without errors`, () => {
      cy.visit(path);
      cy.get('body').should('be.visible');
      cy.get('[data-testid="error"]').should('not.exist');
    });
  });
});
```

### Test de Performance

```javascript
// cypress/e2e/performance.cy.js
describe('Performance Tests', () => {
  it('should load dashboard in under 3 seconds', () => {
    cy.loginAsStudent();
    
    const start = Date.now();
    cy.visit('/student/dashboard');
    cy.get('[data-testid="dashboard-loaded"]').should('be.visible');
    
    cy.then(() => {
      const loadTime = Date.now() - start;
      expect(loadTime).to.be.lessThan(3000);
    });
  });
});
```

### Test Multi-Device

```javascript
// cypress/e2e/responsive.cy.js
describe('Responsive Design Tests', () => {
  const devices = [
    { name: 'desktop', width: 1280, height: 720 },
    { name: 'tablet', width: 768, height: 1024 },
    { name: 'mobile', width: 375, height: 667 }
  ];

  devices.forEach((device) => {
    it(`should work on ${device.name}`, () => {
      cy.viewport(device.width, device.height);
      cy.visit('/student/dashboard');
      cy.get('[data-testid="responsive-nav"]').should('be.visible');
    });
  });
});
```

---

## üìû Support et Contribution

### Contacts
- **D√©veloppeur Principal:** Prof. Alouaoui
- **Repository:** [alouaoui-school](https://github.com/inodev-web/alouaoui-school)
- **Documentation:** Ce guide + README.md

### Contribution aux Tests
1. Fork du repository
2. Cr√©ation de nouveaux tests dans `frontend/cypress/e2e/`
3. Ajout de fixtures appropri√©es dans `frontend/cypress/fixtures/`
4. Test local avec `./scripts/run-e2e-tests.sh`
5. Pull Request avec description d√©taill√©e

### Mise √† Jour de Ce Guide
Ce guide doit √™tre maintenu √† jour avec les √©volutions du projet. Toute modification significative des tests ou de l'infrastructure CI/CD doit √™tre document√©e ici.

---

**üéâ Votre infrastructure de tests E2E est maintenant compl√®tement op√©rationnelle !**